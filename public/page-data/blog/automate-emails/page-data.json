{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/blog/automate-emails/","result":{"data":{"site":{"siteMetadata":{"title":"Mark Witt Homepage + Blog","author":"Mark Witt"}},"mdx":{"id":"8d777f10-fa8f-5b49-b830-5eabcbcd0ccb","excerpt":"What this is good for   To automate the creation of online accounts, we need to perform the same http requests that a user does when signing up programmaticallyâ€¦","body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"layout\": \"post\",\n  \"title\": \"Automating email verification for online accounts using JavaScript\",\n  \"description\": \"Programming and deploying a server that automatically clicks email verification links\",\n  \"date\": \"19.09.2020\",\n  \"published\": true\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h1\", null, \"What this is good for\"), mdx(\"p\", null, \"  To automate the creation of online accounts, we need to perform the same http requests that a user does when signing up programmatically. If it is a website, you can use the DevTools to inspect the network traffic and look it up. If it is an app, you can use an emulator and a tool like \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://mitmproxy.org/\"\n  }), \"mitmproxy\"), \" to monitor http requests.\\nThen you can write a quite simple script which creates hundreds of user accounts in a matter of seconds.\"), mdx(\"p\", null, \"  \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"put a gentle timeout in between http requests so your script will not be considered as a Denial of Service attack\")), mdx(\"p\", null, \"  Most online services require users to have an account linked to a valid email address. To verify that the user really has access to the provided email address, companies use an email verification system in form of a special link sent via email which contains some id and has to be clicked in order to verify.\"), mdx(\"p\", null, \"  I am going to show you how to automate that with some simple JavaScript.\"), mdx(\"h1\", null, \"Domain and Mandrill Setup\"), mdx(\"p\", null, \"  First, We need our own domain to create as many email addresses as we want.\\nI am using NameCheap in this guide but you can use whatever you are comfortable with.\"), mdx(\"p\", null, \"  \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"if you are a student, you can use \", mdx(\"a\", _extends({\n    parentName: \"em\"\n  }, {\n    \"href\": \"https://education.github.com/pack\"\n  }), \"GitHub student developer pack\"), \" to get a free .me domain\")), mdx(\"p\", null, \"  We want to use \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://mandrillapp.com/inbound\"\n  }), \"MailChimp/Mandrill\"), \"'s Inbound API which has a good free tier to POST any incoming email to a Webhook we will setup later. Again, there's other services such as SendGrid which do the same job, so feel free to use anything you want to.\"), mdx(\"p\", null, \"  Follow the instructions to \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://mailchimp.com/help/verify-a-domain/\"\n  }), \"verify an Email Domain\"), \" at Mailchimp!\"), mdx(\"p\", null, \"  We will have to setup some DNS records.\"), mdx(\"p\", null, \"  \", mdx(\"img\", _extends({\n    parentName: \"p\"\n  }, {\n    \"src\": \"https://namecheap.simplekb.com//SiteContents/2-7C22D5236A4543EB827F3BD8936E153E/media/advanced_dns.png\",\n    \"alt\": \"Namecheap Advanced DNS\"\n  }))), mdx(\"p\", null, \"  Navigate to \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://mandrillapp.com/inbound\"\n  }), \"https://mandrillapp.com/inbound\"), \", add your domain and click \\\"View Setup Instructions\\\". You will need to add 2 DNS records of type \\\"MX\\\" which will set Mandrill as the Mailserver for your domain.\"), mdx(\"p\", null, \"  Click \\\"Test DNS Settings\\\".\\\" If it works, proceed:\"), mdx(\"h1\", null, \"Let's start coding\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Create a new folder and call it what you want\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"cd into it and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"npm init\"), \" (assuming you have \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://nodejs.org/\"\n  }), \"node.js\"), \" installed\"), mdx(\"p\", {\n    parentName: \"li\"\n  }, mdx(\"img\", _extends({\n    parentName: \"p\"\n  }, {\n    \"src\": \"https://dev-to-uploads.s3.amazonaws.com/i/2el1zvg5jdleby46ssai.png\",\n    \"alt\": \"Screenshot from 2020-09-19 12-35-04\"\n  })))), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"We will need 3 dependencies and 1 optional devDependency:\"))), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://expressjs.com/\"\n  }), \"express\"), \" to setup a server that listens for incoming http requests\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://cheerio.js.org/\"\n  }), \"cheerio\"), \" to parse the HTML structure of an incoming email and filter out the link we need to click to verify our email address by an attribute (in this case the text Content of the link but it could be any html attribute)\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://pptr.dev/\"\n  }), \"puppeteer\"), \" to access the link href inside an automated browser environment (these verification systems use redirects and JavaScript so sending a simple GET request will not do in most cases)\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://nodemon.io/\"\n  }), \"nodemon\"), \": this devDependency automatically reruns our app when a file in the project changes.\\nRun:\", mdx(\"pre\", {\n    parentName: \"li\"\n  }, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-shell\"\n  }), \"npm install cheerio express puppeteer\\nnpm i -D nodemon\\n\")))), mdx(\"ol\", {\n    \"start\": 4\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Let's make an app.js file in our project directory and create a simple express app:\"), mdx(\"pre\", {\n    parentName: \"li\"\n  }, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-javascript\"\n  }), \"const express = require(\\\"express\\\");\\nconst app = express();\\nconst cheerio = require(\\\"cheerio\\\");\\nconst puppeteer = require(\\\"puppeteer\\\");\\napp.use(express.urlencoded());\\n/* this middleware enables us to access the http body\\n(containing our emails) coming from Mandrill */\\napp.get(\\\"/\\\", (req, res) => res.sendStatus(200));\\n/*adding a get route shows to Mandrill that the url \\\"exists\\\"\\nby sending an \\\"OK\\\" status code. */\\napp.post(\\\"/\\\", (req, res) => {\\n  console.log(req.body);\\n  // let us just console.log the body for now...\\n  req.sendStatus(200);\\n});\\napp.listen(process.env.PORT || 3000);\\n/*for local development, our server will run on port 3000\\nWhen deployed, the PORT environment will be created by\\nHeroku */\\n\"))), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"In package.json, add two npm scripts:\"), mdx(\"pre\", {\n    parentName: \"li\"\n  }, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {}), \"\\\"scripts\\\": {\\n    \\\"start\\\": \\\"node app.js\\\",\\n    \\\"dev\\\": \\\"nodemon start\\\"\\n  },\\n\"))), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Run \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"npm run dev\"), \" to start a local server. Notice that it reruns everytime you change something and save.\"))), mdx(\"h1\", null, \"build a tunnel using ngrok\"), mdx(\"p\", null, \"  ngrok is a super cool free utility that we can use to tunnel our localhost server to the world wide web.\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Download ngrok and unzip it into your project directory\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"add a .gitignore file:\"), mdx(\"pre\", {\n    parentName: \"li\"\n  }, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {}), \"ngrok\\n#on windows: ngrok.exe\\nnode_modules\\n\"))), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"run \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ngrok http 3000\"), \"\\n\", mdx(\"img\", _extends({\n    parentName: \"p\"\n  }, {\n    \"src\": \"https://blog.intercomassets.com/blog/wp-content/uploads/2019/11/lauras-post-request.png\",\n    \"alt\": \"ngrok Screenshot\"\n  })))), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"copy the full .ngrok.io address from your command line (keep in mind that it will change if you restart ngrok)\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Go to \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://mandrillapp.com/inbound\"\n  }), \"Mandrill Inbound\"), \" ->\\nSelect your Domain -> Routes and add a new Route.\\nEnter an asterik (\", \"*\", \") in the first field to forward all email addresses to your webhook. Paste your ngrok url in the second field.\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Save the webhook, select it in the dashboard and click \\\"send test\\\". If everything is working, you will get something logged to your console.\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Use \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"JSON.parse(unescape(req.body.mandrill_events)\"), \" to get a valid object that you can explore. You can iterate over emails using forEach.\"), mdx(\"pre\", {\n    parentName: \"li\"\n  }, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-javascript\"\n  }), \"app.post(\\\"/\\\", (req, res) => {\\n  console.log(req.body);\\n  const mandrillEvents = JSON.parse(unescape(req.body.mandrill_events));\\n\\n  mandrillEvents.forEach((mandrillEvent) => {\\n    const html = mandrillEvent.msg.html;\\n    parse(html); //implemented in next step\\n  });\\n  res.sendStatus(200);\\n});\\n\")))), mdx(\"h1\", null, \"Extracting the desired url using cheerio\"), mdx(\"p\", null, \"  We now have the html content of our email as a string.\\nLet us use cheerio to parse it and extract our link:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-javascript\"\n  }), \"const LINK_TEXT = \\\"verify email address\\\"; //adjust this\\nfunction parse(html) {\\n  const $ = cheerio.load(html, {\\n    withDomLvl1: true,\\n    normalizeWhitespace: true,\\n    decodeEntities: true,\\n  });\\n  /* creates a traversable Document tree from your html string\\n      Now, let us iterate over every anchor tag and see\\n      if it is the link we are looking for */\\n  $(\\\"a\\\").each((i, link) => {\\n    const href = link.attribs[\\\"href\\\"];\\n    if (link.childNodes[0].data) {\\n      if (link.childNodes[0].data.includes(LINK_TEXT)) clickLink(href); //will be implemented in the next step\\n    }\\n  });\\n}\\n\")), mdx(\"p\", null, \"  Notice that the code you need may differ from mine depending on your email html structure. Analyze it by saving the html on your file system and opening it in your web browser. The cheerio library has a very similar syntax to jQuery.\"), mdx(\"h1\", null, \"\\\"Clicking the link\\\" using puppeteer\"), mdx(\"p\", null, \"  Puppeteer is a library which allows you to run an automated Chromium instance.\"), mdx(\"p\", null, \"  Let us create a clickLink function to open the url provided url.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-javascript\"\n  }), \"async function clickLink(href) {\\n  const browser = await puppeteer.launch({ headless: false });\\n  /* setting \\\"headless\\\" to false enables us \\n  to actually see what is going on behind the scenes*/\\n  const page = await browser.newPage();\\n  await page.goto(href);\\n  console.log(\\\"Puppeteer is at \\\" + href);\\n}\\n\")), mdx(\"h1\", null, \"Deployment using Heroku\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Create a \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"heroku.com\"\n  }), \"Heroku\"), \" account and sign it\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Download and install the \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://devcenter.heroku.com/articles/heroku-cli\"\n  }), \"Heroku CLI\"))), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Run \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"heroku login\"), \" and follow the instructions\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"cd into the project directory and run \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"git init && heroku create\"))), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"For technical reasons which I am not the right person to explain, we need to install the node buildpack and the \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://elements.heroku.com/buildpacks/jontewks/puppeteer-heroku-buildpack\"\n  }), \"puppeteer buildpack\"), \" for Heroku:\\n\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"heroku buildpacks:add jontewks/puppeteer && heroku buildpacks:add heroku/nodejs\"))), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"The puppeteer buildpack requires us to run puppeteer with the argument \\\"--no-sandbox\\\". At the same time, we want it to run in \\\"headless\\\" mode on the server (without gui).\"), mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Let's create two constants \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"devOptions\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"prodOptions\"), \":\"), mdx(\"pre\", {\n    parentName: \"li\"\n  }, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-javascript\"\n  }), \"  const devOptions = {\\n    headless: false,\\n  };\\n  const prodOptions = {\\n    args: [\\\"--no-sandbox\\\"],\\n    //\\\"headless\\\" defaults to tru\\n  };\\n\")), mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Inside the heroku dyno, the environment variable \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"NODE_ENV\"), \" is setto \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"\\\"production\\\"\"), \". We can use it to run puppeteer with differentoptions depending on if we are running it locally or inside Heroku.\\nChange the first line inside clickLink:\"), mdx(\"pre\", {\n    parentName: \"li\"\n  }, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-javascript\"\n  }), \"  const browser = await puppeteer.launch(\\n    process.env.NODE_ENV === \\\"production\\\" ? prodOptions : devOptions\\n  );\\n\"))), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"We're ready to rumble. Open your terminal and run\"), mdx(\"pre\", {\n    parentName: \"li\"\n  }, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-shell\"\n  }), \"  git add .\\n  git commit -am \\\"whatever message you want to put here i don't care\\\"\\n  git push heroku master\\n\"))), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Type \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"heroku info -s\"), \" and copy the Web URL from your terminal. Paste it as the webhook URL inside Mandrill Inbound Dashboard. Now, everything should work as expected.\"), mdx(\"p\", {\n    parentName: \"li\"\n  }, \"If it doesn't work or you have anything else you want to tell me, feel free to hit me up anytime on \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://twitter.com/markwitt_me\"\n  }), \"Twitter\"), \" or via \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"mailto:hello@markwitt.me\"\n  }), \"E-Mail\"), \".\"), mdx(\"p\", {\n    parentName: \"li\"\n  }, \"This is my first blog post and I am always grateful to hear any feedback or suggestions from you guys \\uD83E\\uDD20\"))));\n}\n;\nMDXContent.isMDXComponent = true;","frontmatter":{"title":"Automating email verification for online accounts using JavaScript","description":"Programming and deploying a server that automatically clicks email verification links"}}},"pageContext":{"slug":"/automate-emails/","previous":null,"next":null}},"staticQueryHashes":[]}